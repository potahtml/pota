"use strict";var e=require("@babel/helper-plugin-utils"),t=require("@babel/plugin-syntax-jsx"),n=require("@babel/core"),r=require("@babel/helper-module-imports"),s=require("validate-html-nesting");function i(e,t){return e.get(`@babel/plugin-pota-jsx/${t}`)}function o(e,t,n){return e.set(`@babel/plugin-pota-jsx/${t}`,n)}const a=(e,t,s)=>o(t,"id/"+s,function(e,t,s){return()=>{let a=i(t,`imports/${s}`);return a?n.types.cloneNode(a):(a=r.addNamed(e,s,"pota/src/renderer/@main.js",{importedInterop:"uncompiled",importPosition:"after"}),o(t,`imports/${s}`,a),a)}}(e,t,s)),p=(e,t,r)=>n.types.callExpression(i(e,`id/${t}`)(),r),u=(e,t)=>n.types.callExpression(n.types.identifier(e),t);function l(e,t){throw e.buildCodeFrameError(t)}function c(e,t,n){""!==n.trim()?/"|'|=|<|>|`|\s/.test(n)?e.content+=" "+t+"='"+f(n)+"'":e.content+=" "+t+"="+n:e.content+=" "+t}function m(e){return n.types.isStringLiteral(e.value.expression)||n.types.isNumericLiteral(e.value.expression)?String(e.value.expression.value):String(e.value.value)}function d(e,t){return n.types.jSXAttribute(n.types.jSXIdentifier(e),n.types.stringLiteral(t))}const f=(()=>{const e={"'":"&#39;",'"':"&quot;"},t=/['"]/g,n=t=>e[t];return function(e){return e.replace(t,n)}})();function g(e,t){const r=e.reduce(y,[]);if(t&&t.length>0&&r.push(function(e){let t;if(1===e.length)t=e[0];else{if(!(e.length>1))return;t=n.types.arrayExpression(e)}return n.types.objectProperty(n.types.identifier("children"),t)}(t)),r.length)return n.types.objectExpression(r)}function y(e,t){if(t="node"in t?t.node:t,n.types.isJSXSpreadAttribute(t)){const r=t.argument;return n.types.isObjectExpression(r)&&!h(r)?e.push(...r.properties):e.push(n.types.spreadElement(r)),e}const r=(s=t.value||n.types.booleanLiteral(!0),n.types.isJSXExpressionContainer(s)?s.expression:s);var s,i;n.types.isStringLiteral(r)&&!n.types.isJSXExpressionContainer(t.value)&&(r.value=r.value.replace(/\n\s+/g," "),null==(i=r.extra)||delete i.raw);return n.types.isJSXNamespacedName(t.name)?t.name=n.types.stringLiteral(t.name.namespace.name+":"+t.name.name.name):n.types.isValidIdentifier(t.name.name,!1)?t.name.type="Identifier":t.name=n.types.stringLiteral(t.name.name),e.push(n.types.inherits(n.types.objectProperty(t.name,r),t)),e}const h=e=>e.properties.some((e=>n.types.isObjectProperty(e,{computed:!1,shorthand:!1})&&(n.types.isIdentifier(e.key,{name:"__proto__"})||n.types.isStringLiteral(e.key,{value:"__proto__"})))),v=new Set(["area","base","basefont","bgsound","br","col","command","embed","frame","hr","image","img","input","keygen","link","menuitem","meta","param","source","track","wbr"]);function b(e){return v.has(e.toLowerCase())}function x(e,t,n){s.isValidHTMLNesting(e,t)||l(n._path,`Invalid HTML: <${e}> cannot be child of <${t}>`)}const L=(()=>{const e={"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"},t=/[&<>'"]/g,n=t=>e[t];return function(e){return e.replace(t,n)}})();function S(e){const t=e.get("openingElement"),r=E(t.node.name,t.node);let s;return n.types.isIdentifier(r)?s=r.name:n.types.isStringLiteral(r)&&(s=r.value),!!n.types.react.isCompatTag(s)&&s}function E(e,t){return n.types.isJSXIdentifier(e)?"this"===e.name&&n.types.isReferenced(e,t)?n.types.thisExpression():n.types.isValidIdentifier(e.name,!1)?(e.type="Identifier",e):n.types.stringLiteral(e.name):n.types.isJSXMemberExpression(e)?n.types.memberExpression(E(e.object,e),E(e.property,e)):n.types.isJSXNamespacedName(e)?n.types.stringLiteral(`${e.namespace.name}:${e.name.name}`):e}function _(e,t){let r=!1;const s=S(e),i={tagName:s,content:`<${s} pota`,props:[]},o=[];for(const t of e.get("openingElement").get("attributes")){if(t.isJSXAttribute()&&n.types.isJSXIdentifier(t.node.name)){const e=t.node.name.name;if("xmlns"===e&&(r=!0),"xmlns"!==e&&(a=t.node,n.types.isStringLiteral(a.value)||n.types.isNumericLiteral(a.value)||n.types.isStringLiteral(a.value?.expression)||n.types.isNumericLiteral(a.value?.expression))){c(i,e,m(t.node));continue}}o.push(t)}var a;if(!r)switch(s){case"svg":o.push(d("xmlns","http://www.w3.org/2000/svg")),r=!0;break;case"math":o.push(d("xmlns","http://www.w3.org/1998/Math/MathML")),r=!0;break;case"foreignObject":o.push(d("xmlns","http://www.w3.org/1999/xhtml")),r=!0}b(s)?i.content+=" />":i.content+=">";let u=n.types.react.buildChildren(e.node);!function(e,t){for(const n of t)j(n)&&x(e,n.tagName,n)}(i.tagName,u),u=function(e,t){const n=[];for(let r=0;r<e.length;r++){const s=e[r];if(X(s))t.content+=$(s),n.push(s);else{if(!j(s))break;t.content+=N(s),s.arguments[1].elements.length&&t.props.push(...s.arguments[1].elements),n.push(s)}}return e.filter((e=>!n.includes(e)))}(u,i),u=w(u);const l=g(o,u);l?i.props.unshift(l):i.content=i.content.replace(/^<([^\s]+) pota/,"<$1"),b(s)||(i.content+=`</${s}>`);const f=p(t,"createPartial",[n.types.stringLiteral(i.content),n.types.arrayExpression(i.props)]);return f.isXML=r,f.isPartial=!0,f.tagName=s,f._path=e,f}function j(e){return e.isPartial&&!e.isXML}function N(e){return e.arguments[0].value}function w(e){const t=[];let n=0,r=e[n],s=e[++n];for(;r&&s;){if(X(r)){if(X(s)){r.value+=$(s),t.push(s),s=e[++n];continue}if(j(s)){s.arguments[0].value=$(r)+N(s),t.push(r),r=s,s=e[++n];continue}}if(j(r)){if(X(s)){r.arguments[0].value+=$(s),t.push(s),s=e[++n];continue}if(j(s)){r.arguments[0].value+=N(s),s.arguments[1].elements.length&&r.arguments[1].elements.push(...s.arguments[1].elements),t.push(s),s=e[++n];continue}}r=s,s=e[++n]}return e.filter((e=>!t.includes(e)))}function C(e){return w(n.types.react.buildChildren(e.node))}function X(e){return n.types.isStringLiteral(e)||n.types.isNumericLiteral(e)||n.types.isStringLiteral(e.value?.expression)||n.types.isNumericLiteral(e.value?.expression)}function $(e){return n.types.isStringLiteral(e.value?.expression)||n.types.isNumericLiteral(e.value?.expression)?L(e.value?.expression.value):L(e.value)}function P(e,t){const r=g(e.get("openingElement").get("attributes"),C(e)),s=function(e){const t=e.get("openingElement");return E(t.node.name,t.node)}(e),i=function(e){const t=e.get("openingElement"),r=E(t.node.name,t.node);if(n.types.isIdentifier(r))return r.name;if(n.types.isStringLiteral(r))return r.value;if(n.types.isMemberExpression(r))return r.object.name+"."+r.property.name;throw console.log(r),e.buildCodeFrameError("Cannot figure out `tagName` for JSX function.")}(e);if(!t.pota.components[i]){const n=e.scope;t.pota.components[i]=n.generateUidIdentifier("_"+i),n.push({id:t.pota.components[i],init:p(t,"createComponent",[s])})}return u(t.pota.components[i].name,r?[r]:[])}function J(e,t){const r=[];r.push(n.types.jsxAttribute(n.types.jsxIdentifier("__dev"),n.types.jsxExpressionContainer(function(e,t){const r=e.node.loc;if(!r)return e.scope.buildUndefinedNode();const s=t.filename.replace(/\\/g,"/"),i=r.start.line||0,o=r.start?.column+1||0,a=s+":"+i+":"+o,p=e.node.name.object?e.node.name.object.name+"."+e.node.name.property.name:e.node.name.name||"unknown";return n.template.expression.ast`{
		__pota: {
			type: ${n.types.stringLiteral(n.types.react.isCompatTag(p)&&!p.includes(".")?"Tag":"Component")},
			name: ${n.types.stringLiteral(p)},

			file: ${n.types.stringLiteral(a)}
		}
  	}`}(e,t)))),e.pushContainer("attributes",r)}function I(e,t){const r=e.node.callee?.name;if("render"===r){const n=M(e);k(e,t,e.node.arguments,n,4)}else if("root"===r){const n=M(e);k(e,t,e.node.arguments,n,2)}else if("effect"===r||"syncEffect"===r||"asyncEffect"===r){const n=M(e);k(e,t,e.node.arguments,n,2)}else if("memo"===r){const n=function(e,t){return M(e)}(e);k(e,t,e.node.arguments,n,2)}else if("signal"===r){const n=function(e,t){return M(e)}(e);k(e,t,e.node.arguments,n,2)}else if("Component"===r){const r=function(e,t){const r=e.scope.getProgramParent().path.hub.file.opts.filename.replace(/\\/g,"/"),s=e.node.loc.start.line||0,i=e.node.loc?.start?.column+1||0,o=r+":"+s+":"+i,a=e.node.arguments[0];let p;p=n.types.isMemberExpression(a)?a.object.name+"."+a.property.name:n.types.isStringLiteral(a)?a.value:a.name||"unknown";return n.template.expression.ast`{
		__dev:{
			__pota: {
				type: ${n.types.stringLiteral("Component")},
				name: ${n.types.stringLiteral(p)},

				file: ${n.types.stringLiteral(o)}
			}
		}
  	}`}(e);k(e,t,e.node.arguments,r,2)}}function k(e,t,r,s,i){for(i-=1;r.length<i;)r.push(n.types.buildUndefinedNode());if(r[i]){if(n.types.isObjectExpression(r[i])){for(const e of r[i].properties)if(n.types.isObjectProperty(e)&&"__dev"===e.key.name){for(const t of e.value.properties)n.types.isObjectProperty(t)&&"__pota"===t.key.name&&t.value.properties.unshift(...s.properties[0].value.properties[0].value.properties);return}r[i].properties.push(...s.properties)}}else r.push(s)}function M(e,t){const r=e.scope.getProgramParent().path.hub.file.opts.filename.replace(/\\/g,"/")+":"+(e.node.loc.start.line||0)+":"+(e.node.loc?.start?.column+1||0),s=e.node.callee.name;return n.template.expression.ast`{
		__dev:{
			__pota: {
				type: ${n.types.stringLiteral(s)},
				name: ${n.types.stringLiteral(s)},

				file: ${n.types.stringLiteral(r)}
			}
		}
  	}`}var O=function({name:r}){return e.declare(((e,s)=>({name:r,inherits:t.default,visitor:{JSXNamespacedName(e){},JSXSpreadChild(e){l(e,"Spread children are not supported.")},Program:{enter(e,t){t.pota={partials:{},components:{}},a(e,t,"createPartial"),a(e,t,"createComponent"),s?.development&&(e.traverse({CallExpression(e,t){I(e,t)}},t),e.traverse({JSXOpeningElement(e,t){J(e,t)}},t))},exit(e,t){e.traverse({CallExpression(e,t){if(e.node.isPartial){const r=function(e,t){0===e.node.arguments[1].elements.length&&function(e,t){const n=e.indexOf(t);-1!==n&&e.splice(n,1)}(e.node.arguments,e.node.arguments[1]);const r=N(e.node);if(!t.pota.partials[r]){const s=e.scope.getProgramParent();t.pota.partials[r]=s.generateUidIdentifier("_partial");const i=[e.node.arguments[0]],o=e.node.arguments[1]?e.node.arguments[1].elements[0].properties.find((e=>"xmlns"===e?.key?.name))?.value?.value:void 0;o&&i.push(n.types.stringLiteral(o)),s.push({id:t.pota.partials[r],init:p(t,"createPartial",i)})}return u(t.pota.partials[r].name,e.node.arguments[1]?[e.node.arguments[1]]:[])}(e,t);e.replaceWith(n.types.inherits(r,e.node))}}},t)}},JSXFragment:{exit(e,t){const r=function(e,t){const r=C(e);return 1===r.length?r[0]:r.length>1?n.types.arrayExpression(r):void 0}(e);e.replaceWith(n.types.inherits(r,e.node))}},JSXElement:{exit(e,t){const r=S(e)?_(e,t):P(e,t);e.replaceWith(n.types.inherits(r,e.node))}},JSXAttribute(e){n.types.isJSXElement(e.node.value)&&(e.node.value=n.types.jsxExpressionContainer(e.node.value))}}})))}({name:"transform-pota-jsx"});module.exports=O;
