"use strict";var e=require("@babel/helper-plugin-utils"),t=require("@babel/core"),n=require("@babel/plugin-syntax-jsx"),r=require("@babel/helper-module-imports"),s=require("validate-html-nesting");function i(e,t){return e.get(`@babel/plugin-pota-jsx/${t}`)}function o(e,t,n){return e.set(`@babel/plugin-pota-jsx/${t}`,n)}const a=(e,n,s)=>o(n,"id/"+s,function(e,n,s){return()=>{let a=i(n,`imports/${s}`);return a?t.types.cloneNode(a):(a=r.addNamed(e,s,"pota/src/renderer/@main.js",{importedInterop:"uncompiled",importPosition:"after"}),o(n,`imports/${s}`,a),a)}}(e,n,s)),p=(e,n,r)=>t.types.callExpression(i(e,`id/${n}`)(),r),l=(e,n)=>t.types.callExpression(t.types.identifier(e),n);function u(e,t){throw e.buildCodeFrameError(t)}function c(e,t,n){""!==n.trim()?/"|'|=|<|>|`|\s/.test(n)?e.content+=" "+t+"='"+d(n)+"'":e.content+=" "+t+"="+n:e.content+=" "+t}function m(e){return t.types.isStringLiteral(e.value.expression)||t.types.isNumericLiteral(e.value.expression)?String(e.value.expression.value):String(e.value.value)}function f(e,n){return t.types.jSXAttribute(t.types.jSXIdentifier(e),t.types.stringLiteral(n))}const d=(()=>{const e={"'":"&#39;",'"':"&quot;"},t=/['"]/g,n=t=>e[t];return function(e){return e.replace(t,n)}})();function g(e,n){const r=e.reduce(y,[]);if(n&&n.length>0&&r.push(function(e){let n;if(1===e.length)n=e[0];else{if(!(e.length>1))return;n=t.types.arrayExpression(e)}return t.types.objectProperty(t.types.identifier("children"),n)}(n)),r.length)return t.types.objectExpression(r)}function y(e,n){if(n="node"in n?n.node:n,t.types.isJSXSpreadAttribute(n)){const r=n.argument;return t.types.isObjectExpression(r)&&!h(r)?e.push(...r.properties):e.push(t.types.spreadElement(r)),e}const r=(s=n.value||t.types.booleanLiteral(!0),t.types.isJSXExpressionContainer(s)?s.expression:s);var s,i;t.types.isStringLiteral(r)&&!t.types.isJSXExpressionContainer(n.value)&&(r.value=r.value.replace(/\n\s+/g," "),null==(i=r.extra)||delete i.raw);return t.types.isJSXNamespacedName(n.name)?n.name=t.types.stringLiteral(n.name.namespace.name+":"+n.name.name.name):t.types.isValidIdentifier(n.name.name,!1)?n.name.type="Identifier":n.name=t.types.stringLiteral(n.name.name),e.push(t.types.inherits(t.types.objectProperty(n.name,r),n)),e}const h=e=>e.properties.some((e=>t.types.isObjectProperty(e,{computed:!1,shorthand:!1})&&(t.types.isIdentifier(e.key,{name:"__proto__"})||t.types.isStringLiteral(e.key,{value:"__proto__"})))),v=new Set(["area","base","basefont","bgsound","br","col","command","embed","frame","hr","image","img","input","keygen","link","menuitem","meta","param","source","track","wbr"]);function b(e){return v.has(e.toLowerCase())}function x(e,t,n){s.isValidHTMLNesting(e,t)||u(n._path,`Invalid HTML: <${e}> cannot be child of <${t}>`)}const L=(()=>{const e={"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"},t=/[&<>'"]/g,n=t=>e[t];return function(e){return e.replace(t,n)}})();function S(e){const n=e.get("openingElement"),r=E(n.node.name,n.node);let s;return t.types.isIdentifier(r)?s=r.name:t.types.isStringLiteral(r)&&(s=r.value),!!t.types.react.isCompatTag(s)&&s}function E(e,n){return t.types.isJSXIdentifier(e)?"this"===e.name&&t.types.isReferenced(e,n)?t.types.thisExpression():t.types.isValidIdentifier(e.name,!1)?(e.type="Identifier",e):t.types.stringLiteral(e.name):t.types.isJSXMemberExpression(e)?t.types.memberExpression(E(e.object,e),E(e.property,e)):t.types.isJSXNamespacedName(e)?t.types.stringLiteral(`${e.namespace.name}:${e.name.name}`):e}function _(e,n){let r=!1;const s=S(e),i={tagName:s,content:`<${s} pota`,props:[]},o=[];for(const n of e.get("openingElement").get("attributes")){if(n.isJSXAttribute()&&t.types.isJSXIdentifier(n.node.name)){const e=n.node.name.name;if("xmlns"===e&&(r=!0),"xmlns"!==e&&(a=n.node,t.types.isStringLiteral(a.value)||t.types.isNumericLiteral(a.value)||t.types.isStringLiteral(a.value?.expression)||t.types.isNumericLiteral(a.value?.expression))){c(i,e,m(n.node));continue}}o.push(n)}var a;if(!r)switch(s){case"svg":o.push(f("xmlns","http://www.w3.org/2000/svg")),r=!0;break;case"math":o.push(f("xmlns","http://www.w3.org/1998/Math/MathML")),r=!0;break;case"foreignObject":o.push(f("xmlns","http://www.w3.org/1999/xhtml")),r=!0}b(s)?i.content+=" />":i.content+=">";let l=t.types.react.buildChildren(e.node);!function(e,t){for(const n of t)j(n)&&x(e,n.tagName,n)}(i.tagName,l),l=function(e,t){const n=[];for(let r=0;r<e.length;r++){const s=e[r];if(C(s))t.content+=P(s),n.push(s);else{if(!j(s))break;t.content+=$(s),s.arguments[1].elements.length&&t.props.push(...s.arguments[1].elements),n.push(s)}}return e.filter((e=>!n.includes(e)))}(l,i),l=N(l);const u=g(o,l);u?i.props.unshift(u):i.content=i.content.replace(/^<([^\s]+) pota/,"<$1"),b(s)||(i.content+=`</${s}>`);const d=p(n,"createPartial",[t.types.stringLiteral(i.content),t.types.arrayExpression(i.props)]);return d.isXML=r,d.isPartial=!0,d.tagName=s,d._path=e,d}function j(e){return e.isPartial&&!e.isXML}function $(e){return e.arguments[0].value}function N(e){const t=[];let n=0,r=e[n],s=e[++n];for(;r&&s;){if(C(r)){if(C(s)){r.value+=P(s),t.push(s),s=e[++n];continue}if(j(s)){s.arguments[0].value=P(r)+$(s),t.push(r),r=s,s=e[++n];continue}}if(j(r)){if(C(s)){r.arguments[0].value+=P(s),t.push(s),s=e[++n];continue}if(j(s)){r.arguments[0].value+=$(s),s.arguments[1].elements.length&&r.arguments[1].elements.push(...s.arguments[1].elements),t.push(s),s=e[++n];continue}}r=s,s=e[++n]}return e.filter((e=>!t.includes(e)))}function w(e){return N(t.types.react.buildChildren(e.node))}function C(e){return t.types.isStringLiteral(e)||t.types.isNumericLiteral(e)||t.types.isStringLiteral(e.value?.expression)||t.types.isNumericLiteral(e.value?.expression)}function P(e){return t.types.isStringLiteral(e.value?.expression)||t.types.isNumericLiteral(e.value?.expression)?L(e.value?.expression.value):L(e.value)}function X(e,n){const r=g(e.get("openingElement").get("attributes"),w(e)),s=function(e){const t=e.get("openingElement");return E(t.node.name,t.node)}(e),i=function(e){const n=e.get("openingElement"),r=E(n.node.name,n.node);if(t.types.isIdentifier(r))return r.name;if(t.types.isStringLiteral(r))return r.value;if(t.types.isMemberExpression(r))return r.object.name+"."+r.property.name;throw console.log(r),e.buildCodeFrameError("Cannot figure out `tagName` for JSX function.")}(e);if(!n.pota.components[i]){const t=e.scope;n.pota.components[i]=t.generateUidIdentifier("_"+i),t.push({id:n.pota.components[i],init:p(n,"createComponent",[s])})}return l(n.pota.components[i].name,r?[r]:[])}function J(e,n){const r=[];r.push(t.types.jsxAttribute(t.types.jsxIdentifier("__dev"),t.types.jsxExpressionContainer(function(e,n){const r=e.node.loc;if(!r)return e.scope.buildUndefinedNode();const s=n.filename.replace(/\\/g,"/"),i=O(e,n,s),o=r.start.line||0,a=r.start?.column+1||0,p=":"+o+":"+a,l=e.node.name.object?e.node.name.object.name+"."+e.node.name.property.name:e.node.name.name||"unknown";return t.template.expression.ast`{
		__pota: {
			type: ${t.types.stringLiteral(t.types.react.isCompatTag(l)&&!l.includes(".")?"Tag":"Component")},
			name: ${t.types.stringLiteral(l)},

			file: ${i} + ${t.types.stringLiteral(p)}
		}
  	}`}(e,n)))),e.pushContainer("attributes",r)}function I(e,n){const r=e.node.callee?.name;if("render"===r){const t=M(e,n);k(e,n,e.node.arguments,t,4)}else if("root"===r){const t=M(e,n);k(e,n,e.node.arguments,t,2)}else if("effect"===r||"syncEffect"===r||"asyncEffect"===r){const t=M(e,n);k(e,n,e.node.arguments,t,2)}else if("memo"===r){const t=function(e,t){return M(e,t)}(e,n);k(e,n,e.node.arguments,t,2)}else if("signal"===r){const t=function(e,t){return M(e,t)}(e,n);k(e,n,e.node.arguments,t,2)}else if("Component"===r){const r=function(e,n){const r=e.scope.getProgramParent().path.hub.file.opts.filename.replace(/\\/g,"/"),s=O(e,n,r),i=e.node.loc.start.line||0,o=e.node.loc?.start?.column+1||0,a=":"+i+":"+o,p=e.node.arguments[0];let l;l=t.types.isMemberExpression(p)?p.object.name+"."+p.property.name:t.types.isStringLiteral(p)?p.value:p.name||"unknown";return t.template.expression.ast`{
		__dev:{
			__pota: {
				type: ${t.types.stringLiteral("Component")},
				name: ${t.types.stringLiteral(l)},

				file: ${s} + ${t.types.stringLiteral(a)}
			}
		}
  	}`}(e,n);k(e,n,e.node.arguments,r,2)}}function k(e,n,r,s,i){for(i-=1;r.length<i;)r.push(t.types.buildUndefinedNode());if(r[i]){if(t.types.isObjectExpression(r[i])){for(const e of r[i].properties)if(t.types.isObjectProperty(e)&&"__dev"===e.key.name){for(const n of e.value.properties)t.types.isObjectProperty(n)&&"__pota"===n.key.name&&n.value.properties.unshift(...s.properties[0].value.properties[0].value.properties);return}r[i].properties.push(...s.properties)}}else r.push(s)}function M(e,n){const r=e.scope.getProgramParent().path.hub.file.opts.filename.replace(/\\/g,"/"),s=O(e,n,r),i=":"+(e.node.loc.start.line||0)+":"+(e.node.loc?.start?.column+1||0),o=e.node.callee.name;return t.template.expression.ast`{
		__dev:{
			__pota: {
				type: ${t.types.stringLiteral(o)},
				name: ${t.types.stringLiteral(o)},

				file: ${s} + ${t.types.stringLiteral(i)}
			}
		}
  	}`}function O(e,n,r){if(!n.pota.files[r]){const s=e.scope.getProgramParent();n.pota.files[r]=s.generateUidIdentifier("_filename"),s.push({id:n.pota.files[r],init:t.types.stringLiteral(r)})}return n.pota.files[r]}var q=function({name:r}){return e.declare(((e,s)=>({name:r,inherits:n.default,visitor:{JSXNamespacedName(e){},JSXSpreadChild(e){u(e,"Spread children are not supported.")},Program:{enter(e,t){t.pota={partials:{},components:{},files:{}},a(e,t,"createPartial"),a(e,t,"createComponent"),s?.development&&(e.traverse({CallExpression(e,t){I(e,t)}},t),e.traverse({JSXOpeningElement(e,t){J(e,t)}},t))},exit(e,n){e.traverse({CallExpression(e,n){if(e.node.isPartial){const r=function(e,n){0===e.node.arguments[1].elements.length&&function(e,t){const n=e.indexOf(t);-1!==n&&e.splice(n,1)}(e.node.arguments,e.node.arguments[1]);const r=$(e.node);if(!n.pota.partials[r]){const s=e.scope.getProgramParent();n.pota.partials[r]=s.generateUidIdentifier("_partial");const i=[e.node.arguments[0]],o=e.node.arguments[1]?e.node.arguments[1].elements[0].properties.find((e=>"xmlns"===e?.key?.name))?.value?.value:void 0;o&&i.push(t.types.stringLiteral(o)),s.push({id:n.pota.partials[r],init:p(n,"createPartial",i)})}return l(n.pota.partials[r].name,e.node.arguments[1]?[e.node.arguments[1]]:[])}(e,n);e.replaceWith(t.types.inherits(r,e.node))}}},n)}},JSXFragment:{exit(e,n){const r=function(e,n){const r=w(e);return 1===r.length?r[0]:r.length>1?t.types.arrayExpression(r):void 0}(e);e.replaceWith(t.types.inherits(r,e.node))}},JSXElement:{exit(e,n){const r=S(e)?_(e,n):X(e,n);e.replaceWith(t.types.inherits(r,e.node))}},JSXAttribute(e){t.types.isJSXElement(e.node.value)&&(e.node.value=t.types.jsxExpressionContainer(e.node.value))}}})))}({name:"transform-pota-jsx"});module.exports=q;
