"use strict";var e=require("@babel/helper-plugin-utils"),t=require("@babel/core"),n=require("@babel/plugin-syntax-jsx"),r=require("@babel/helper-module-imports"),s=require("validate-html-nesting");function i(e,t){return e.get(`@babel/plugin-pota-jsx/${t}`)}function a(e,t,n){return e.set(`@babel/plugin-pota-jsx/${t}`,n)}const o=(e,n,s)=>a(n,"id/"+s,function(e,n,s){return()=>{let o=i(n,`imports/${s}`);return o?t.types.cloneNode(o):(o=r.addNamed(e,s,"pota/src/renderer/@main.js",{importedInterop:"uncompiled",importPosition:"after"}),a(n,`imports/${s}`,o),o)}}(e,n,s)),p=(e,n,r)=>t.types.callExpression(i(e,`id/${n}`)(),r),l=(e,n)=>t.types.callExpression(t.types.identifier(e),n);function c(e,t){throw e.buildCodeFrameError(t)}function u(e){const n=e.get("openingElement"),r=m(n.node.name,n.node);let s;return t.types.isIdentifier(r)?s=r.name:t.types.isStringLiteral(r)&&(s=r.value),!!t.types.react.isCompatTag(s)&&s}function m(e,n){return t.types.isJSXIdentifier(e)?"this"===e.name&&t.types.isReferenced(e,n)?t.types.thisExpression():t.types.isValidIdentifier(e.name,!1)?(e.type="Identifier",e):t.types.stringLiteral(e.name):t.types.isJSXMemberExpression(e)?t.types.memberExpression(m(e.object,e),m(e.property,e)):t.types.isJSXNamespacedName(e)?t.types.stringLiteral(`${e.namespace.name}:${e.name.name}`):e}function d(e,n){const r=e.reduce(f,[]);if(n&&n.length>0&&r.push(function(e){let n;if(1===e.length)n=e[0];else{if(!(e.length>1))return;n=t.types.arrayExpression(e)}return t.types.objectProperty(t.types.identifier("children"),n)}(n)),r.length)return t.types.objectExpression(r)}function f(e,n){if(n="node"in n?n.node:n,t.types.isJSXSpreadAttribute(n)){const r=n.argument;return t.types.isObjectExpression(r)&&!g(r)?e.push(...r.properties):e.push(t.types.spreadElement(r)),e}const r=(s=n.value||t.types.booleanLiteral(!0),t.types.isJSXExpressionContainer(s)?s.expression:s);var s,i;t.types.isStringLiteral(r)&&!t.types.isJSXExpressionContainer(n.value)&&(r.value=r.value.replace(/\n\s+/g," "),null==(i=r.extra)||delete i.raw);return t.types.isJSXNamespacedName(n.name)?n.name=t.types.stringLiteral(n.name.namespace.name+":"+n.name.name.name):t.types.isValidIdentifier(n.name.name,!1)?n.name.type="Identifier":n.name=t.types.stringLiteral(n.name.name),e.push(t.types.inherits(t.types.objectProperty(n.name,r),n)),e}const g=e=>e.properties.some((e=>t.types.isObjectProperty(e,{computed:!1,shorthand:!1})&&(t.types.isIdentifier(e.key,{name:"__proto__"})||t.types.isStringLiteral(e.key,{value:"__proto__"}))));function y(e,t,n){""!==n.trim()?/"|'|=|<|>|`|\s/.test(n)?e.content+=" "+t+"='"+v(n)+"'":e.content+=" "+t+"="+n:e.content+=" "+t}function h(e){return t.types.isStringLiteral(e.value.expression)||t.types.isNumericLiteral(e.value.expression)?String(e.value.expression.value):String(e.value.value)}function b(e,n){return t.types.jSXAttribute(t.types.jSXIdentifier(e),t.types.stringLiteral(n))}const v=(()=>{const e={"'":"&#39;",'"':"&quot;"},t=/['"]/g,n=t=>e[t];return function(e){return e.replace(t,n)}})(),x=new Set(["area","base","basefont","bgsound","br","col","command","embed","frame","hr","image","img","input","keygen","link","menuitem","meta","param","source","track","wbr"]);function L(e){return x.has(e.toLowerCase())}function S(e,t,n){s.isValidHTMLNesting(e,t)||c(n._path,`Invalid HTML: <${e}> cannot be child of <${t}>`)}const E=(()=>{const e={"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"},t=/[&<>'"]/g,n=t=>e[t];return function(e){return e.replace(t,n)}})();function k(e,n){let r=!1;const s=u(e),i={tagName:s,content:`<${s} pota`,props:[]},a=[];for(const n of e.get("openingElement").get("attributes")){if(n.isJSXAttribute()&&t.types.isJSXIdentifier(n.node.name)){const e=n.node.name.name;if("xmlns"===e&&(r=!0),"xmlns"!==e&&(o=n.node,t.types.isStringLiteral(o.value)||t.types.isNumericLiteral(o.value)||t.types.isStringLiteral(o.value?.expression)||t.types.isNumericLiteral(o.value?.expression))){y(i,e,h(n.node));continue}}a.push(n)}var o;if(!r)switch(s){case"svg":a.push(b("xmlns","http://www.w3.org/2000/svg")),r=!0;break;case"math":a.push(b("xmlns","http://www.w3.org/1998/Math/MathML")),r=!0;break;case"foreignObject":a.push(b("xmlns","http://www.w3.org/1999/xhtml")),r=!0}L(s)?i.content+=" />":i.content+=">";let l=t.types.react.buildChildren(e.node);!function(e,t){for(const n of t)P(n)&&S(e,n.tagName,n)}(i.tagName,l),l=function(e,t){const n=[];for(let r=0;r<e.length;r++){const s=e[r];if(N(s))t.content+=X(s),n.push(s);else{if(!P(s))break;t.content+=j(s),s.arguments[1].elements.length&&t.props.push(...s.arguments[1].elements),n.push(s)}}return e.filter((e=>!n.includes(e)))}(l,i),l=w(l);const c=d(a,l);c?i.props.unshift(c):i.content=i.content.replace(/^<([^\s]+) pota/,"<$1"),L(s)||(i.content+=`</${s}>`);const m=p(n,"createPartial",[t.types.stringLiteral(i.content),t.types.arrayExpression(i.props)]);return m.isXML=r,m.isPartial=!0,m.tagName=s,m._path=e,m}function P(e){return e.isPartial&&!e.isXML}function j(e){return e.arguments[0].value}function w(e){const t=[];let n=0,r=e[n],s=e[++n];for(;r&&s;){if(N(r)){if(N(s)){r.value+=X(s),t.push(s),s=e[++n];continue}if(P(s)){s.arguments[0].value=X(r)+j(s),t.push(r),r=s,s=e[++n];continue}}if(P(r)){if(N(s)){r.arguments[0].value+=X(s),t.push(s),s=e[++n];continue}if(P(s)){r.arguments[0].value+=j(s),s.arguments[1].elements.length&&r.arguments[1].elements.push(...s.arguments[1].elements),t.push(s),s=e[++n];continue}}r=s,s=e[++n]}return e.filter((e=>!t.includes(e)))}function _(e){return w(t.types.react.buildChildren(e.node))}function N(e){return t.types.isStringLiteral(e)||t.types.isNumericLiteral(e)||t.types.isStringLiteral(e.value?.expression)||t.types.isNumericLiteral(e.value?.expression)}function X(e){return t.types.isStringLiteral(e.value?.expression)||t.types.isNumericLiteral(e.value?.expression)?E(e.value?.expression.value):E(e.value)}function $(e,n){const r=d(e.get("openingElement").get("attributes"),_(e)),s=function(e){const t=e.get("openingElement");return m(t.node.name,t.node)}(e),i=function(e){const n=e.get("openingElement"),r=m(n.node.name,n.node);if(t.types.isIdentifier(r))return r.name;if(t.types.isStringLiteral(r))return r.value;if(t.types.isMemberExpression(r))return r.object.name+"."+r.property.name;throw console.log(r),e.buildCodeFrameError("Cannot figure out `tagName` for JSX function.")}(e);if(!n.pota.components[i]){const t=e.scope;n.pota.components[i]=t.generateUidIdentifier("_"+i),t.push({id:n.pota.components[i],init:p(n,"createComponent",[s])})}return l(n.pota.components[i].name,r?[r]:[])}function C(e,n){const r=[];r.push(t.types.jsxAttribute(t.types.jsxIdentifier("__dev"),t.types.jsxExpressionContainer(function(e,n){const r=e.node.loc;if(!r)return e.scope.buildUndefinedNode();const s=n.filename.replace(/\\/g,"/"),i=A(e,n,s),a=r.start.line||0,o=r.start?.column+1||0,p=":"+a+":"+o,l=e.node.name.object?e.node.name.object.name+"."+e.node.name.property.name:e.node.name.name||"unknown";return function(e,n,r,s){return t.template.expression.ast`{
		__pota: {
			kind: ${t.types.stringLiteral(e)},
			name: ${t.types.stringLiteral(n)},

			file: ${r} + ${t.types.stringLiteral(s)}
		}
  	}`}(t.types.react.isCompatTag(l)&&!l.includes(".")?"element":"component",l,i,p)}(e,n)))),e.pushContainer("attributes",r)}function I(e,n){const r=e.node.callee?.name;switch(r){case"signal":case"memo":{const t=M(e,n);J(e.node.arguments,t,2);break}case"render":{const t=M(e,n);J(e.node.arguments,t,4);break}case"root":{const t=M(e,n);J(e.node.arguments,t,2);break}case"effect":case"syncEffect":case"asyncEffect":{const t=M(e,n);J(e.node.arguments,t,2);break}case"Component":{const r=function(e,n){const r=e.scope.getProgramParent().path.hub.file.opts.filename.replace(/\\/g,"/"),s=A(e,n,r),i=e.node.loc.start.line||0,a=e.node.loc?.start?.column+1||0,o=":"+i+":"+a,p=e.node.arguments[0];let l;l=t.types.isMemberExpression(p)?p.object.name+"."+p.property.name:t.types.isStringLiteral(p)?p.value:p.name||"unknown";return U("component",l,s,o)}(e,n);J(e.node.arguments,r,2);break}}}function J(e,n,r){for(r-=1;e.length<r;)e.push(t.types.buildUndefinedNode());if(e[r]){if(t.types.isObjectExpression(e[r])){for(const s of e[r].properties)if(t.types.isObjectProperty(s)&&"__dev"===s.key.name){for(const e of s.value.properties)t.types.isObjectProperty(e)&&"__pota"===e.key.name&&e.value.properties.unshift(...n.properties[0].value.properties[0].value.properties);return}e[r].properties.push(...n.properties)}}else e.push(n)}function M(e,t){const n=e.scope.getProgramParent().path.hub.file.opts.filename.replace(/\\/g,"/"),r=A(e,t,n),s=":"+(e.node.loc.start.line||0)+":"+(e.node.loc?.start?.column+1||0),i=e.node.callee.name;return U(i,i,r,s)}function O(e,t){const n=e.scope.getProgramParent().path.hub.file.opts.filename.replace(/\\/g,"/"),r=A(e,t,n),s=":"+(e.node.left.loc.start.line||0)+":"+(e.node.left.loc?.start?.column+1||0);return U(e.node.right.callee.name,t.file.code.slice(e.node.left.start,e.node.left.end),r,s)}function q(e,t,n){const r=e.scope.getProgramParent().path.hub.file.opts.filename.replace(/\\/g,"/"),s=A(e,n,r),i=":"+(e.node.loc.start.line||0)+":"+(e.node.loc?.start?.column+1||0),a=t.init.callee.name;let o="unknown";switch(t.id.type){case"ArrayPattern":o=t.id.elements[0].name;break;case"ObjectPattern":o=t.id.properties.find((e=>"read"===e.key.name)).value.name;break;case"Identifier":o=t.id.name}return U(a,o,s,i)}function A(e,n,r){if(!n.pota.files[r]){const s=e.scope.getProgramParent();n.pota.files[r]=s.generateUidIdentifier("_filename"),s.push({id:n.pota.files[r],init:t.types.stringLiteral(r)})}return n.pota.files[r]}function U(e,n,r,s){return t.template.expression.ast`{
		__dev:{
			__pota: {
				kind: ${t.types.stringLiteral(e)},
				name: ${t.types.stringLiteral(n)},

				file: ${r} + ${t.types.stringLiteral(s)}
			}
		}
  	}`}var T=function({name:r}){return e.declare(((e,s)=>({name:r,inherits:n.default,visitor:{JSXNamespacedName(e){},JSXSpreadChild(e){c(e,"Spread children are not supported.")},Program:{enter(e,t){t.pota={partials:{},components:{},files:{}},o(e,t,"createPartial"),o(e,t,"createComponent"),s?.development&&e.traverse({CallExpression(e,t){I(e,t)},JSXOpeningElement(e,t){C(e,t)},AssignmentExpression(e,t){!function(e,t){const n=e.node.right.callee?.name;switch(n){case"signal":{const n=O(e,t);J(e.node.right.arguments,n,2);break}case"memo":{const n=O(e,t);J(e.node.right.arguments,n,2);break}}}(e,t)},VariableDeclaration(e,t){!function(e,t){for(const n of e.node.declarations){const r=n.init?.callee?.name;switch(r){case"signal":{const r=q(e,n,t);J(n.init.arguments,r,2);break}case"memo":{const r=q(e,n,t);J(n.init.arguments,r,2);break}}}}(e,t)}},t)},exit(e,n){e.traverse({CallExpression(e,n){if(e.node.isPartial){const r=function(e,n){0===e.node.arguments[1].elements.length&&function(e,t){const n=e.indexOf(t);-1!==n&&e.splice(n,1)}(e.node.arguments,e.node.arguments[1]);const r=j(e.node);if(!n.pota.partials[r]){const s=e.scope.getProgramParent();n.pota.partials[r]=s.generateUidIdentifier("_partial");const i=[e.node.arguments[0]],a=e.node.arguments[1]?e.node.arguments[1].elements[0].properties.find((e=>"xmlns"===e?.key?.name))?.value?.value:void 0;a&&i.push(t.types.stringLiteral(a)),s.push({id:n.pota.partials[r],init:p(n,"createPartial",i)})}return l(n.pota.partials[r].name,e.node.arguments[1]?[e.node.arguments[1]]:[])}(e,n);e.replaceWith(t.types.inherits(r,e.node))}}},n)}},JSXFragment:{exit(e,n){const r=function(e,n){const r=_(e);return 1===r.length?r[0]:r.length>1?t.types.arrayExpression(r):void 0}(e);e.replaceWith(t.types.inherits(r,e.node))}},JSXElement:{exit(e,n){const r=u(e)?k(e,n):$(e,n);e.replaceWith(t.types.inherits(r,e.node))}},JSXAttribute(e){t.types.isJSXElement(e.node.value)&&(e.node.value=t.types.jsxExpressionContainer(e.node.value))}}})))}({name:"transform-pota-jsx"});module.exports=T;
